<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共同編輯平台</title>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Gun.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        .container {
            margin-top: 2rem;
        }
        #messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        #editor {
            height: 300px;
            border: 1px solid #ddd;
            padding: 1rem;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }
        .online-users {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <h2>共同編輯區</h2>
                <div class="online-users">
                    <small>在線使用者: <span id="userCount">0</span></small>
                </div>
                <div id="editor" contenteditable="true" class="form-control"></div>
            </div>
            <div class="col-md-4">
                <h2>聊天室</h2>
                <div id="messages" class="mb-3"></div>
                <div class="input-group mb-2">
                    <input type="text" id="nameInput" class="form-control" placeholder="你的名字" style="max-width: 150px;">
                    <input type="text" id="messageInput" class="form-control" placeholder="輸入訊息...">
                    <button class="btn btn-primary" onclick="sendMessage()">發送</button>
                </div>
                <button class="btn btn-danger btn-sm" onclick="clearChat()">清除聊天室</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 初始化 GUN
        const gun = Gun({
            peers: ['https://gun-manhattan.herokuapp.com/gun']
        });

        // 建立聊天室和文件編輯節點
        const chatRoom = gun.get('chat-room');
        const document = gun.get('document');
        const users = gun.get('users');

        // 產生隨機使用者 ID
        const userId = Math.random().toString(36).substring(7);
        
        // 更新使用者狀態
        users.set({ id: userId, lastSeen: Date.now() });
        setInterval(() => {
            users.set({ id: userId, lastSeen: Date.now() });
        }, 2000);

        // 監控在線使用者
        let onlineUsers = new Set();
        users.map().on(function(data, id) {
            if (data && data.lastSeen > Date.now() - 5000) {
                onlineUsers.add(data.id);
            } else {
                onlineUsers.delete(data.id);
            }
            document.getElementById('userCount').textContent = onlineUsers.size;
        });

        // 文件編輯功能
        const editor = document.getElementById('editor');
        let isTyping = false;

        editor.addEventListener('input', function(e) {
            if (!isTyping) {
                document.put({
                    content: editor.innerHTML,
                    lastEdit: Date.now()
                });
            }
        });

        document.on(function(data) {
            if (data && data.content && data.lastEdit) {
                isTyping = true;
                editor.innerHTML = data.content;
                isTyping = false;
            }
        });

        // 聊天室功能
        function sendMessage() {
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const name = nameInput.value || '訪客';
            const message = messageInput.value.trim();

            if (message) {
                chatRoom.set({
                    name: name,
                    message: message,
                    timestamp: Date.now()
                });
                messageInput.value = '';
            }
        }

        chatRoom.map().on(function(data, id) {
            if (data) {
                const messagesDiv = document.getElementById('messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'mb-2';
                const time = new Date(data.timestamp).toLocaleTimeString();
                messageElement.innerHTML = `<small>${time}</small> <strong>${data.name}:</strong> ${data.message}`;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        });

        // 清除聊天室功能
        function clearChat() {
            if (confirm('確定要清除所有聊天記錄嗎？')) {
                // 清除畫面上的訊息
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                // 清除 Gun.js 中的聊天記錄
                chatRoom.put(null);
            }
        }

        // 按下 Enter 鍵發送訊息
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>